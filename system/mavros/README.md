# `starling-mavros` Container

This container holds both MAVROS and a ROS1/2 bridge. In the future, we expect to use the ROS2 version of MAVROS which
will eliminate the need for the ROS1/2 bridge.

## Launch Process

The initial process of starting the container goes through `ros_entrypoint.sh`. This file sets up both ROS versions and
runs a setup script which configures the environment to tell MAVROS how to talk to the drone and where to publish its
topics. The setup script works in a couple of different ways depending on where the container is running.

If the container is running on a drone, it expects to be able to find the `/etc/starling/vehicle.config` file. This file
contains some information that MAVROS needs to be able to communicate with the flight controller. An example
`vehicle.config` file is included below.

If the container is started as part of a Kubernetes StatefulSet deployment, the setup script will attempt to get the
ordinal of its containing pod from the hostname. It will then use this ordinal to set up the ports and the system ID to
match those generated by a PX4 SITL instance set up with the same ordinal. If the setup script fails to get the ordinal
from the hostname, it will attempt to connect to a PX4 SITL with `PX4_INSTANCE=0`.

Once the setup script has run, the default behaviour is to launch the `mavros_bridge.launch.xml` file. This behaviour
should be usable in almost all cases. This is a __ROS2__ launch file. It instructs `ros2 launch` to run the
`ros1_bridge` node and an instance of __ROS1__'s `roslaunch`. This in turn launches the __ROS1__ `mavros.launch` file,
which contains instructions to run the MAVROS node.

The __ROS2__ `mavros_bridge.launch.xml` script defines a set of arguments to enable configuration of the MAVROS node.
These are ususally filled by the environment variables defined below. If the configurability provided here is
insufficient, the image can be run with a different command.

## Environment Variables

Name                  | Default Value      | Description
----------------------|--------------------|------------
`MAVROS_FCU_CONN`     | "udp"              | Protocol for autogenerated FCU URL
`MAVROS_FCU_IP`       | "127.0.0.1"        | IP for autogenerated FCU_URL
`MAVROS_FCU_UDP_BASE` | "14830"            | Base port for autogenerated FCU_URL
`MAVROS_TGT_SYSTEM`   | "auto"             | Target system ID, if set to a number, this will __override__ the automatic behaviour
`PX4_INSTANCE_BASE`   | 0                  | Base instance for autogenerated instance matching
`MAVROS_TGT_FIRMWARE` | "px4"              | Firmware profile used by MAVROS. Only other valid value currently is "apm"
`MAVROS_GCS_URL`      | "udp-pb://@:14550" | MAVROS URL for ground control station connection
`MAVROS_FCU_URL`      | {unset}            | MAVROS URL for FCU connection. Set to __override__ automatic behaviour
`VEHICLE_NAMESPACE`   | {unset}            | Namespace for mavros topics. Set to __override__ default value of `vehicle_${TGT_SYSTEM}`

`MAVROS_FCU_URL` is autogenerated as:
> `$MAVROS_FCU_CONN://$MAVROS_FCU_IP:$((MAVROS_FCU_UDP_BASE + INSTANCE))@`

If no Kubernetes deployment is detected, this ends up as:
> `udp://127.0.0.1:14830@`

Similarly, if no Kubernetes is detected, `MAVROS_TGT_SYSTEM` will end up as `1`,

## Build Process

At the time of writing, there is not a binary distribution available for `mavros_msgs` under ROS2. Therefore, this
package needs to be built from source. In addition, to ensure support for custom message types, `ros1_bridge` also needs
to be built from source. The build process also includes some additional steps to complete the installation of MAVROS
under ROS1.

## Example `vehicle.config`

Note that the extended form of the serial URL is required for MAVROS's target "query string" to work.

```bash
VEHICLE_FCU_URL=serial:///dev/px4fmu:115200
VEHICLE_FIRMWARE=px4
VEHICLE_MAVLINK_SYSID=23
VEHICLE_VICON_NAME=clover23
```

## Behaviour Notes

### Running on a vehicle

Ensure `/etc/starling/vehicle.config` is mounted. The container is then configured from the contents of that file.

### Running under Kubernetes StatefulSet

The container is configured based on the detected ordinal from the hostname.

`MAVROS_FCU_URL` is autogenerated as: `udp://127.0.0.1:$((14830 + ORDINAL))@`

`MAVROS_TGT_SYSTEM` will end up as `$((ORDINAL + 1))`

### Running isolated

Default values will be used, equivalent to the Kubernetes case with `ORDINAL=0`
